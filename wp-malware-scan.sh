#!/usr/bin/env bash
#
# wp-malware-scan.sh
#
# WordPress malware scan helper:
#   - Detects WordPress installs under /home
#   - Runs Maldet recursive scans (with quarantine)
#   - Optionally runs ClamAV recursive scans
#   - Greps for common obfuscated malware patterns in wp-content
#
# Usage (direct from GitHub, example):
#   bash <(curl -fsSL https://raw.githubusercontent.com/lunaweb89/setup-secure-server.sh/main/wp-malware-scan.sh)
#
# Recommended: run after your secure-server setup script.

set -euo pipefail

# ----------------- Config ----------------- #

WP_BASE_DIR="/home"
LOG_DIR="/var/log"
MALDET_LOG="${LOG_DIR}/wp-malware-maldet.log"
CLAMAV_LOG="${LOG_DIR}/wp-malware-clamav.log"
SUSPICIOUS_LOG="${LOG_DIR}/wp-malware-suspicious.log"

RUN_CLAMAV="yes"   # set to "no" if you want to skip ClamAV in this script

# ----------------- Helpers ----------------- #

log() { echo "[+] $*"; }

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    echo "[-] ERROR: This script must run as root (sudo)." >&2
    exit 1
  fi
}

check_bin() {
  local b="$1"
  if ! command -v "$b" >/dev/null 2>&1; then
    echo "[-] Required binary '$b' not found. Please run the secure-server setup script first or install it." >&2
    return 1
  fi
}

# ----------------- Start ----------------- #

require_root

mkdir -p "$LOG_DIR"

log "Looking for WordPress installations under ${WP_BASE_DIR}..."
# Find wp-config.php up to a reasonable depth
mapfile -t WP_CONFIGS < <(find "$WP_BASE_DIR" -maxdepth 6 -type f -name "wp-config.php" 2>/dev/null || true)

if [[ "${#WP_CONFIGS[@]}" -eq 0 ]]; then
  echo "[-] No WordPress installations found under ${WP_BASE_DIR} (no wp-config.php files)." >&2
  exit 1
fi

log "Found ${#WP_CONFIGS[@]} WordPress install(s):"
for cfg in "${WP_CONFIGS[@]}"; do
  echo "    - $(dirname "$cfg")"
done

# Check tools
log "Checking required tools (Maldet, ClamAV)..."
check_bin maldet || { echo "[-] Maldet missing; aborting." >&2; exit 1; }
if [[ "$RUN_CLAMAV" == "yes" ]]; then
  check_bin clamscan || { echo "[-] clamscan missing; disable RUN_CLAMAV or install ClamAV." >&2; }
fi

echo ""
log "Starting malware scans..."
echo "    Maldet log    : $MALDET_LOG"
echo "    ClamAV log    : $CLAMAV_LOG (if enabled)"
echo "    Suspicious log: $SUSPICIOUS_LOG"
echo ""

# Clear old logs (optional)
: > "$MALDET_LOG"
: > "$CLAMAV_LOG"
: > "$SUSPICIOUS_LOG"

# ----------------- Per-site scanning ----------------- #

SITE_NUM=0

for cfg in "${WP_CONFIGS[@]}"; do
  SITE_NUM=$((SITE_NUM + 1))
  DOCROOT="$(dirname "$cfg")"

  log "[$SITE_NUM] Scanning site at: ${DOCROOT}"

  # --- Maldet scan ---
  log "[$SITE_NUM] Running Maldet recursive scan (with quarantine)..."
  # -r path 1 = recursive, 1 = scan all file types
  # -b = background; we log output manually
  /usr/local/maldetect/maldet -b -r "$DOCROOT" 1 >> "$MALDET_LOG" 2>&1 || \
    echo "[-] [$SITE_NUM] Maldet scan encountered errors, check $MALDET_LOG" >&2

  # --- ClamAV scan (optional) ---
  if [[ "$RUN_CLAMAV" == "yes" ]] && command -v clamscan >/dev/null 2>&1; then
    log "[$SITE_NUM] Running ClamAV recursive scan..."
    clamscan -ri "$DOCROOT" >> "$CLAMAV_LOG" 2>&1 || true
  fi

  # --- Grep for common obfuscation / webshell patterns in wp-content ---
  if [[ -d "${DOCROOT}/wp-content" ]]; then
    log "[$SITE_NUM] Grepping for suspicious PHP patterns in wp-content..."
    grep -R --line-number --color=never \
      -E 'base64_decode *\(|gzinflate *\(|shell_exec *\(|passthru *\(|proc_open *\(|popen *\(|eval *\(|assert *\(|system *\(' \
      "${DOCROOT}/wp-content" \
      >> "$SUSPICIOUS_LOG" 2>/dev/null || true
  fi

  echo ""
done

# ----------------- Summary / Tips ----------------- #

log "Scans completed."

cat <<EOF

========================================================
 WordPress Malware Scan Summary
========================================================

Maldet scan log:      ${MALDET_LOG}
ClamAV scan log:      ${CLAMAV_LOG}
Suspicious patterns:  ${SUSPICIOUS_LOG}

Next steps:

1) View Maldet reports:
   maldet --report list

   For a specific SCANID shown in that list:
   maldet --report SCANID

   If some infections are not yet quarantined, you can:
   maldet --quarantine SCANID

2) Review suspicious patterns log:
   less ${SUSPICIOUS_LOG}

   Look for PHP files with strange long encoded strings, random function names,
   or code at the very top of core/theme/plugin files.

3) If ClamAV is enabled, review its log:
   less ${CLAMAV_LOG}

   It will show files it flags as infected or suspicious.

IMPORTANT:
- Always backup critical sites before mass deletion.
- Quarantine (via Maldet) is safer than direct rm -rf so you can restore if needed.

EOF
